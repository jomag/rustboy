on:
  push

jobs:
  update_test_report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      
      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libsdl2-dev
          sudo pip3 install jinja2-cli

      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable

      - uses: Swatinem/rust-cache@v1

      - name: Build emulator
        run: cargo build --release
      
      - name: Run MoonEye tests
        run: |
          curl https://gekkio.fi/files/mooneye-test-suite/mts-20211031-2031-86d1acf/mts-20211031-2031-86d1acf.tar.xz -o mts.tar.xz
          tar xf mts.tar.xz
          mv mts-20211031-2031-86d1acf test/mooneye-test-suite
          python3 ./doc/build-test-protocol.py
      
      - name: Generate README
        run: jinja2 doc/README.tpl.md -o README.md.new

      - name: Commit if README was changed        
        run: |
          git config --global user.name 'Test Runner Bot'
          git config --global user.email 'jonatan.magnusson@gmail.com'
          git commit -am "Auto-updated README"
          git push
